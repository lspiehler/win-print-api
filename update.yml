---
  - name: Install Windows Updates
    hosts: "{{ match_host }}"
    vars:
      install_dir: "C:\\win-print-api"
      repo: "https://github.com/lspiehler/win-print-api.git"
    tasks:
      - name: Check if install directory exists
        win_stat:
          path: "{{ install_dir }}"
        register: repo_dir
      - name: Clone repo and create service
        block:
          - name: Create install directory
            win_file:
              path: "{{ install_dir }}"
              state: directory
          - name: Clone repo
            win_command: "git clone {{ repo }} {{ install_dir }}"
            args:
              chdir: "C:\\Program Files\\Git\\bin"
          - name: Install dependencies
            win_command: "npm.cmd install {{ install_dir }} --prefix {{ install_dir }}"
            args:
              chdir: "C:\\Program Files\\nodejs"
          - name: Create service
            win_command: "node {{ install_dir }}\\service.js"
            args:
              chdir: "C:\\Program Files\\nodejs"
        when: not repo_dir.stat.exists
      - name: Update repo and start service
        block:
          - name: Update repo
            win_command: "git pull origin master"
            args:
              chdir: "{{ install_dir }}"
          - name: Update dependencies
            win_command: "npm.cmd install {{ install_dir }} --prefix {{ install_dir }}"
            args:
              chdir: "C:\\Program Files\\nodejs"
        when: repo_dir.stat.exists